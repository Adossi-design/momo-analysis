<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoMo Transaction Dashboard</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header>
            <h1>MTN MoMo Transaction Dashboard</h1>
            <div class="last-updated">
                Historical SMS Data Analysis
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card">
                <h3>Total Transactions</h3>
                <p class="big-number">{{ total_transactions|thousands }}</p>
            </div>
            
            <div class="card">
                <h3>Current Month</h3>
                <p class="big-number">{{ current_month.total|thousands }} RWF</p>
                <p>{{ current_month.count|thousands }} transactions</p>
            </div>
            
            <div class="card">
                <h3>Average Transaction</h3>
                <p class="big-number">
                    {% if total_transactions > 0 %}
                        {{ "{:,.0f}".format((current_month.total / current_month.count) if current_month.count > 0 else 0) }} RWF
                    {% else %}
                        0 RWF
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="analytics-section">
            <div class="chart-container">
                <h2>Monthly Transaction Volume</h2>
                <canvas id="monthlyChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>Transaction Type Distribution</h2>
                <canvas id="typeChart"></canvas>
            </div>
        </div>

        <!-- Transaction Details -->
        <div class="transaction-details">
            <div class="recent-transactions">
                <h2>Recent Transactions</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount (RWF)</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in recent_transactions %}
                            <tr>
                                <td>{{ tx.readable_date or tx.transaction_date[:10] }}</td>
                                <td class="tx-type-{{ tx.transaction_type }}">
                                    {{ tx.transaction_type|title }}
                                </td>
                                <td>{{ tx.amount|thousands }}</td>
                                <td>{{ tx.sender or tx.recipient or tx.message_body[:30] + '...' if tx.message_body else 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="type-breakdown">
                <h2>Transaction Type Breakdown</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Count</th>
                            <th>Total Amount</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for type in type_stats %}
                        <tr>
                            <td class="tx-type-{{ type.type_name }}">{{ type.type_name|title }}</td>
                            <td>{{ type.count|thousands }}</td>
                            <td>{{ type.total|thousands }} RWF</td>
                            <td>
                                {% if total_transactions > 0 %}
                                    {{ "{:.1%}".format(type.total / current_month.total) if current_month.total > 0 else "0%" }}
                                {% else %}
                                    0%
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="/static/js/dashboard.js"></script>
    
    <script>
        // Initialize Monthly Chart
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: {{ monthly_stats|map(attribute='month')|tojson }},
                datasets: [{
                    label: 'Transaction Volume (RWF)',
                    data: {{ monthly_stats|map(attribute='total')|tojson }},
                    backgroundColor: '#FF6D00',
                    borderColor: '#E65100',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' RWF';
                            }
                        }
                    }
                }
            }
        });

        // Initialize Type Distribution Chart
        const typeCtx = document.getElementById('typeChart').getContext('2d');
        new Chart(typeCtx, {
            type: 'doughnut',
            data: {
                labels: {{ type_stats|map(attribute='type_name')|tojson }},
                datasets: [{
                    data: {{ type_stats|map(attribute='total')|tojson }},
                    backgroundColor: [
                        '#4CAF50', '#2196F3', '#FFC107',
                        '#FF5722', '#9C27B0', '#607D8B'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw.toLocaleString()} RWF`;
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
